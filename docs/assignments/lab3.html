<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Big Data for Public Good - Lab 3 Machine Learning &amp; Prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Big Data for Public Good</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-modules" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Modules</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-modules">    
        <li>
    <a class="dropdown-item" href="../modules/module1-0.html">
 <span class="dropdown-text">Module 1 - Introduction to Big Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../modules/module2-0.html">
 <span class="dropdown-text">Module 2 - Types of Big Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../modules/module3-0.html">
 <span class="dropdown-text">Module 3 - Discovery &amp; Insights</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../modules/module4-0.html">
 <span class="dropdown-text">Module 4 - Bias in Big Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../modules/module5-0.html">
 <span class="dropdown-text">Module 5 - Data Privacy &amp; Stewardship</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../modules/module6-0.html">
 <span class="dropdown-text">Module 6 - Course Conclusion</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignments" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assignments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assignments">    
        <li>
    <a class="dropdown-item" href="../discussions/M1-1.html">
 <span class="dropdown-text">Discussions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/lab1.html">
 <span class="dropdown-text">Labs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/data-certification-plan.html">
 <span class="dropdown-text">Data Certification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/project_proposal.html">
 <span class="dropdown-text">Big Data Project Proposal</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resources" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Resources</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-resources">    
        <li>
    <a class="dropdown-item" href="../resources/rubrics-written.html">
 <span class="dropdown-text">Rubrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../resources/grade-policy.html">
 <span class="dropdown-text">Grade and Policies</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <a href="https://github.com/yemeng-emma/bigdata4publicgood" title="" class="quarto-navigation-tool px-1" aria-label="github"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Lab 3 Machine Learning &amp; Prediction</h1>
        </a>     
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../assignments/lab1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 1 Social Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../assignments/lab2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 2 Open Data and Discovery</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../assignments/lab3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lab 3 Machine Learning &amp; Prediction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../assignments/lab4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 4 Bias in Modeling</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Lab 3 Machine Learning &amp; Prediction</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Overview</strong></p>
<p>In the previous lab we examined the practice of feature selection - identifying the proper set of variables to use as inputs into a predictive model. Gottman developed a framework using 20 micro-expressions coded at one-second intervals. Iceland developed a set of variables that help predict whether teens are likely to abuse alcohol.</p>
<p>A key pattern that emerges from the case studies and a take-away from Lab 2 is that identifying the proper data to include in a model is difficult. Typically, experts start with a large number of measures and eliminate variables as they are tested. It requires patience and attention to detail to identify the right set of variables for a given problem.</p>
<p>This week we will explore the process of “feature engineering,” the task of starting from raw data sources and “engineering” new variables by finding ways to code or extract new features. Feature engineering is common when using data like satellite imagery, document archives, or video. It is common that the data was not designed for the task at hand, but it contains rich information that is extremely valuable if it can be extracted.</p>
<p>Feature engineering is also necessary because predictive models typically require quantitative variables, so data sources like images and text need to be transformed into counts and scales. “Engineering” can be simple or complex. A simple example is computing a new variable, BMI, from two existing ones (height and weight). More complex examples of what this process might look like for unstructured data are below.</p>
<p>For example, how can a computer read handwriting? It has to be able to translate easily from an image of hand-written text to some sort of mathematical abstraction of the sentences.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_1.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>It accomplishes this by isolating words, then isolating individual characters, then using a pixel grid to code which features exist on each character (vertical lines, curved lines, cross-bars, etc.), and making a prediction about which letter might be based upon specific features.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_2.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
<p><em>(Note, the elements above are concepts from typography that describe fonts, not a list of features from natural language processing, but you get the idea)</em></p>
<p>Without a set of features extracted from the raw image of a character, the computer can’t predict which letter it might be. In this way Lab 4 on Feature Engineering combines elements of Lab 2 on Measurement, and Lab 3 on Feature Selection. You “engineer” or “extract” a feature by first defining it (does the character possess a “bowl”), and then figuring out how the computer will observe or measure that feature.</p>
<p>The goal of this lab is to <strong>demonstrate a couple of processes of feature engineering from common machine learning and artificial intelligence applications</strong>. I would like you to develop an intuitive sense of how engineers approach the creative endeavor of turning raw data into meaningful quantitative measures. Some steps below show how raw data might be processed to make it interpretable (to code characters from text, you first need to isolate individual characters). Others steps show how raw data is translated into a quantitative variable that can be used as an input into a model.</p>
<p>As you read through the lab, think about the readings from <em>Social Physics</em>. How did computer scientists approach the task of understanding team performance in organizations? What sorts of <a href="https://connection.mit.edu/human-strategy-0">data did they collect</a>, and how did they generate quantitative measures from the raw data inputs of environmental sensors and employee smart badges? There are thousands of potential variables you could generate from human interactions in organizations, so how did they decide which measures were important? These themes will be revisited when we look at how Google tried to design the perfect team.</p>
<p>We start here with some basic examples of feature engineering in a few task domains.</p>
<p><strong>Optical Character Recognition</strong></p>
<p>The process by which computer programs read handwriting or scan images of text is quite interesting because of how raw image files are converted into structured data. The process is broadly called <a href="https://blog.filestack.com/thoughts-and-knowledge/history-of-ocr/">Optical Character Recognition</a>. <a href="https://www.youtube-nocookie.com/embed/bmTp-6lDQEA">short video</a></p>
<p>For these tasks the program must first take an image and identify the different units of text:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_3.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
<p>These can then be broken into the most basic component parts, characters. The actual predictive models that comprise programs reading text occur on a letter by letter basis, and the paragraphs are reconstructed after all letters are identified:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>For these programs to work the computer must be able to effectively isolate each character:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_5.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Images are a challenging data source because camera resolution, light sources, distance from the subject, and focus can all impact data quality. As a result, the first step in many applications that require computers to extract features from images is to process the image in a way that isolates the important information and standardizes some of the inputs.</p>
<p>Let’s consider this basic program that allows you to take a picture of a graph, then will generate the underlying data for you. It does this by identifying the trend line, converting it to a pixel grid, then for each horizontal pixel measuring the vertical location of the trend line.</p>
<p>Input image data can be messy, though. So first we need to standardize it to isolate the trend line.</p>
<p><strong>Raw image of a graph</strong>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_6.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p><strong>Step 1</strong>: Convert the colored picture to a grayscale version that emphasizes boundaries of graphics.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_7.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p><strong>Step 2</strong>: Filter out any data that is below a threshold for opacity or darkness.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_8.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p><strong>Step 3</strong>: Convert to a negative view to maximize the contrast of the image.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_9.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>The use of filters in this way is a common first step for models that use images as raw data sources. This will be true for self-driving vehicles that use cameras to collect data streams, or examples from the&nbsp;<em>Digital Humanitarians</em>&nbsp;text that use satellite images to predict the location of damage from a disaster. Next we will look at how these techniques are used to conduct a tree census.</p>
<p>For an interesting urban policy application of this approach, thanks to an&nbsp;<a href="https://www.nytimes.com/interactive/2018/10/12/us/map-of-every-building-in-the-united-states.html">program built by Microsoft</a>&nbsp;you can now download a database of every single building in the United States that was built by an AI application that was taught to read satellite images.</p>
<p>Does anyone recognize this community?</p>
<p><img src="..\pictures/pic_lab3_10.jpg" class="img-fluid quarto-figure quarto-figure-center" style="width:99.0%"> <strong>Trees</strong></p>
<p>Trees are important for cities, but maintaining a robust urban forest is expensive and challenging. “Trees clean the air and water, reduce stormwater floods, improve building energy use, and mitigate climate change, among other things. For every dollar invested in planting, cities see an average $2.25 return on their investment each year.” <a href="https://www.citylab.com/environment/2018/04/heres-how-much-money-trees-save-in-megacities/559211/">cite</a></p>
<p>If we want to decide where to plant trees in our city by bringing a data-driven approach to tree policy, we first need to measure the outcome. “How many trees are in your city? It might seem like a straightforward question, but finding the answer can be a monumental task. New York City’s 2015-2016 tree census, for example, took nearly two years (12,000 hours total) and more than 2,200 volunteers.” <a href="https://www.citylab.com/environment/2018/12/urban-tree-canopy-maps-artificial-intelligence-descartes-labs/578701/">cite</a></p>
<p>Using high-resolution images that can capture a wide spectrum of light, data scientists have <a href="https://medium.com/descarteslabs-team/descartes-labs-urban-trees-tree-canopy-mapping-3b6c85c5c9cc">designed ways to use public data sources and AI to perform this task</a>. Here is a high-resolution image of Washington DC that has eliminated all of the light except that reflecting off of green objects, i.e.&nbsp;plant life in the city (as opposed to buildings and parking lots):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_11.gif" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:79.0%"></p>
</figure>
</div>
<p>Easy enough, right? But wait! Green patches might be grass, shrubs, or flowers. How does the program know NOT to count these green patches as trees?</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_12.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:79.0%"></p>
</figure>
</div>
<p>It turns out that trees reflect green light differently than other plants. If you apply the right filters you can further isolate the trees in the image from the rest of the plants. For example, watch the grass in the park disappear:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_13.gif" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:79.0%"></p>
</figure>
</div>
<p>Or eliminate all of the open green spaces in Boston (the grass at the airport is especially vivid):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_14.gif" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:79.0%"></p>
</figure>
</div>
<p>These techniques allow us to isolate trees from everything else. But we now have another problem - a green island rarely contains a single tree. How can we isolate individual trees from a group of trees in a cluster?</p>
<p>The nice <a href="https://cran.r-project.org/web/packages/ForestTools/vignettes/treetopAnalysis.html">tutorial on tree canopy analysis</a>&nbsp;offers some solutions.</p>
<p>The basic recipe for identifying trees within a cluster is to:</p>
<p><strong>1. Apply a Filter</strong> to isolate trees from other elements on the landscape.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_15.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:59.0%"></p>
</figure>
</div>
<p><strong>2. Detect Treetops</strong> using <a href="https://www.researchgate.net/publication/225076692_Seeing_the_Trees_in_the_Forest_Using_Lidar_and_Multispectral_Data_Fusion_with_Local_Filtering_and_Variable_Window_Size_for_Estimating_Tree_Height">an algorithm</a> that can predict the height of each pixel in the image.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_16.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:59.0%"></p>
</figure>
</div>
<p>This step returns the geographic coordinates of each tree-top in the cluster so that you can see the tree through the forest.</p>
<p>Note that Lidar uses lasers to enhance digital photographic techniques by including rich measures of light frequency and the ability to triangulate height. Lidar is an expensive technology, but many cities have a database of Lidar images that are open for public use.</p>
<p><strong>3. Model Canopies</strong> by using a geometric tesselation algorithm to predict canopy boundaries and create a new spatial file that contains both tree coordinates, heights, and canopy sizes.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_17.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:59.0%"></p>
</figure>
</div>
<p>This information would be useful for tracking the number of trees as well as changes in canopies over time.</p>
<p><strong>Faces</strong></p>
<p>Facial recognition software has become accurate and ubiquitous. What features does a computer need in order to recognize a person? How are these features engineered from a two-dimensional image of a face?</p>
<p><strong>Feature Extraction</strong></p>
<p>Similar to the programs that read text in images above by identifying text then isolating characters, facial recognition software starts by scanning an image to look for faces. If it finds one it then has a routine to frame the face, then isolate prominent features on the face:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_18.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:55.0%"></p>
</figure>
</div>
<p>Similar to the hand-writing recognition example, we can apply filters to an image to accentuate specific features. With letters on paper we are trying to maximize the contrast between the ink and the page. With faces, different filters applied to images (or image processing algorithms) will highlight specific facial features.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_19.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>Once oriented to the face, an algorithm can identify facial landmarks (which is actually similar to how our own brains recognize faces):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_20.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>The computer translates the landmark view of a small set of prominent features of a face to a grid model that measures the distance between each feature:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_21.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>Voila! We now have a format that can be used to generate quantitative variables describing a face. Each line represents a distance between facial landmarks. The length of each line becomes a distinct feature that can be measured and quantified.</p>
<p>You don’t always know the distance from the camera to the face, so you might not be able to predict the actual size of specific features (is my nose big or was the camera just way too close?), but it is easy enough to calculate relative sizes. If you set the distance between the eyes as a measure of one unit, for example, then every other distance on this graph (each line) can be calculated relative to that distance. Thus, you are not identifying individuals based upon the actual size of their noses, but by the relative distances between all features on their face.</p>
<p>There are&nbsp;<a href="https://towardsdatascience.com/face-detection-for-beginners-e58e8f21aad9">different ways</a>&nbsp;to accomplish this basic process of creating abstract mathematical models of the face. They all return a list of quantitative features that describe an individual face.</p>
<p>And finally, we compare the measurements from a specific face against measurements in a large database of candidate faces. You can do this quickly because you are working with a few dozen measures (distance between eyes, distance between edges of the mouth, distance between edge of mouth to eye, etc.). You would calculate the difference between the face you are trying to identify, and each face in the database by comparing the length of each line.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_22.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>If the total distance between all of the features falls below a threshold, then the faces are flagged as a match to be examined further by a human, or some action is triggered (unlocking your phone or your front door, for example).</p>
<p><strong>Feature Selection</strong></p>
<p>Assuming that the photos are taken in good light with forward-facing subjects and decent resolution cameras, what do you anticipate being a challenge with this process? Facial feature landmarks might vary greatly based upon expressions (or angles of the camera):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_23.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>Note that some features, like distance between the eyes and size of the nose, will be <strong>static</strong> (i.e., reliable measures). Others, like the edges of the mouth or the size of lips, will be&nbsp;<strong>highly dependent upon the expression</strong> (i.e., low alpha if we think about facial features as latent constructs).</p>
<p>Stated another way, some features convey more information about the unique identity of an individual than others. The feature selection task is to identify which measures will contain the highest signal-to-noise ratios. The algorithms that match faces can also weight certain features more than others to account for expressions.</p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0010027718302397">This paper</a> explores the issue by examining which facial features contain the most information during the recognition task. They do this by examining which features, when changed, render the individual most unrecognizable.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_24.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>Stated differently, if you omitted the high-salience features from your model like lip thickness, you would see a large drop in correct matches to the database. If you omit low-salience features like mouth size, you experience a lower impact on the accuracy of facial recognition.</p>
<p>This example is meant to give you an intuitive sense of what the computer algorithm might experience as features are “corrupted” in the images and remind you of the importance of the feature selection task.</p>
<p>So, if you are trying to escape the country by crossing a border, which feature would you try to disguise?</p>
<p><strong>LAB QUESTIONS</strong></p>
<p><strong>Part 1: Letters</strong></p>
<p>Assume you have designed a program that can effectively isolate individual characters from an image of a license plate:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_25.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p>You now want to develop a machine learning model that will accurately identify each character, so you need to develop a set of features that describe the letters so the computer can begin to tell them apart.</p>
<p>For the lab, <strong>list three features of characters</strong>&nbsp;that could be reliably derived (“engineered”) from an image of a single letter and used as input data for a predictive model that can read a license plate accurately. Note that fonts used by states might vary, so letters and digits will not be identical.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_26.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_27.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>If you think this sounds challenging, recognize that there are hundreds of potential features (characteristics of the letter). Just look at how many terms hipsters have invented to lovingly diagram their favorite typefaces:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_28.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>Or spend five minutes with a <a href="https://www.wikihow.com/Tell-What-Someone-is-Like-from-Their-Handwriting">hand-writing analyst</a>.</p>
<p>It may be helpful for you to start by describing the difference between these letters to a child.</p>
<ul>
<li><p>You might start by pondering how someone would distinguish the difference between a lowercase “o” and a lowercase “a”.</p></li>
<li><p>How would you describe the difference between a “1” and an “l”?</p></li>
<li><p>Between a zero “0” and an upper-case “O”?</p></li>
<li><p>Capital “T” versus lower-case “t”?</p></li>
</ul>
<p><strong>Part 2: Using Uniforms to Predict Job Title</strong></p>
<p>The blog <strong>Toward Data Science</strong> describes an interesting machine learning application that&nbsp;<a href="https://towardsdatascience.com/train-image-recognition-ai-with-5-lines-of-code-8ed0bdd8d9ba">predicts which category that an object or person belongs to based upon an image</a>. They demonstrate the software by training it to guess people’s career based upon a picture of them at work:</p>
<p><em>For this tutorial, we have provided a dataset called IdenProf. IdenProf (Identifiable Professionals) is a dataset that contains 11,000 pictures of 10 different professionals that humans can see and recognize their jobs by their mode of dressing.</em></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_29.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%"></p>
</figure>
</div>
<p>There are ten professions used in the example:</p>
<ol type="1">
<li><p>Chef</p></li>
<li><p>Doctor</p></li>
<li><p>Engineer</p></li>
<li><p>Farmer</p></li>
<li><p>Firefighter</p></li>
<li><p>Judge</p></li>
<li><p>Mechanic</p></li>
<li><p>Pilot</p></li>
<li><p>Police</p></li>
<li><p>Waiter</p></li>
</ol>
<p><em>This dataset is split into 9000 pictures (900 pictures for each profession) to train the artificial intelligence model and 2000 pictures (200 pictures for each profession) to test the performance of the artificial intelligence model as it is training. IdenProf has been properly arranged and made ready for training your artificial intelligence model to recognize professionals by their mode of dressing. For reference purposes, if you are using your own image dataset, you must collect at least 500 pictures for each object or scene you want your artificial intelligence model to recognize.</em></p>
<p><strong>For the lab</strong>, suggest three features of uniforms that might be used to classify images from a profession. Also include a rule statement about how the feature maps the specific profession.</p>
<p>For example:</p>
<p><strong>Rule:</strong> If the uniform has stripes on the arms,&nbsp;<strong>Prediction</strong>&nbsp;the individual will be either a fire fighter or a pilot.</p>
<p>Some more examples:</p>
<ul>
<li><p>If the uniform includes a skirt the individual is not a farmer, mechanic, or chef (on the job).</p></li>
<li><p>If the uniform is mostly black, the individual will be a judge, pilot, or police officer.</p></li>
<li><p>If the uniform is mostly white, the individual will be a chef or a doctor.</p></li>
<li><p>If the uniform includes a bow tie, the individual will likely be a waiter (or an engineer?).</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_30.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p><strong>Part 3: Home Values</strong></p>
<p>We have focused so far on feature engineering examples that use images as the input data, then extract features based upon models of letter style, tree structure, or the topology of faces. In these instances, we are translating from one data type (an image) to a traditional set of quantitative variables in a spreadsheet format (columns represents variables or features, and rows represent observations).</p>
<p>It is also common to engineer features from an existing dataset, to create new variables from existing variables. For example, population density is a common variable used in urban policy. This variable requires that you have a measure of the population of an administrative unit (number of people in a census tract) and the total geographic area of that unit. Density is then calculated as people per square mile (or whatever unit you use for area).</p>
<p>Population density is often a more useful variable than the raw population because it tells you something about the average distance between individuals in a city. If you are opening a pizza delivery business, for example, the total population of the city does not matter if they are spread out over a large area. You will be more profitable serving a smaller population that is packed into a tight neighborhood than a large suburb which requires long delivery times and high operating costs. Stated differently, population density is a better predictor of the profitability of your new business.</p>
<p>The urban policy research group, Urban Spatial, offers a nice example of this in a model they created to&nbsp;<a href="http://urbanspatialanalysis.com/portfolio/predicting-gentrification-using-longitudinal-census-data/">predict gentrification of census tracts using historic census data</a>.</p>
<p>They describe several features that they engineer for the model. Similar to other community change models we have examined, they measure characteristics of housing in census tracts to predict how each might change over time.</p>
<p>One thing they do differently from previous models, however, is use information about home value contagion. When home values rise in an adjacent census tract it increases the likelihood that home values rise in my census tract. This type of relationship is called a spatial correlation. This might occur because people that are looking to buy in a specific neighborhood might be priced out by rising costs in that neighborhood, so they instead purchase a home in an adjacent neighborhood. Higher demand from the spill-over will drive up prices.</p>
<p>Similarly, a drop in prices in a neighborhood can have a contagion effect if buyers looking at purchasing in an adjacent neighborhood get nervous about falling prices and look elsewhere, thus reducing the demand and lowering prices, resulting in a self-fulling prophesy in some instances.</p>
<p>To model these processes, you need to take into account information about neighboring communities. The paper Urban Spatial explains how they create (engineer) two variables (features) for their model.</p>
<p>One variable is created by calculating the average value of homes in all of the surrounding census tracts. Only those census tracts that are contiguous to your own (they share a border) are included. So, the census tract in the top left corner is excluded in the calculation, for example:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_31.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p>The second variable was created after recognizing that the average value of surrounding homes might not be the best predictor of change. Rather, homeowners typically want to move into hot neighborhoods that have nice amenities and cool people. Since everyone wants to move there, though, these neighborhoods quickly become saturated and overpriced, and buyers spill over into nearby neighborhoods.</p>
<p>They identified all of the census tracts in the top 5th of the data (the top 20% of tracts based upon home values) and categorize them as highly-desirable tracts. They then calculate the distance from each tract in the dataset to the nearest highly-desirable tract:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="..\pictures/pic_lab3_31.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p>If we are predicting home values for a tract in 2010, the value in 2000 will provide a reference point for where home values start but will not tell you much about whether you expect them to be rising or falling. The value of neighboring tracts, however, is a good predictor (if adjacent tracts have more expensive homes, prices are likely to rise, if they have cheaper homes, prices will likely fall). And the distance to the closest “hot” neighborhood in 2000 will provide a different type of information about possible trends. The two variables that explain trends are both second-order variables that are created from the raw census data.</p>
<p><strong>For the Lab</strong>: recall that in the previous lab you were required to identify a neighborhood or metropolitan feature that impacts home values (for example, <a href="https://www.nber.org/papers/w24952">every time a Starbucks opens in a new neighborhood home values increase by 0.5%</a>).</p>
<p><strong>Using the feature that you identified in Lab 2</strong>&nbsp;(or another you may need to choose), explain how you would “engineer” it by answering the following questions. <strong>You are NOT allowed to use a metric that is already an existing census variable and requires no engineering (i.e., calculation).</strong></p>
<p><strong>1. What is your unit of analysis? Census tract, zip code, city, etc.</strong></p>
<p>Some variables are better at a very local scale (crimes tend to impact prices on surrounding blocks but not much further), whereas others are only meaningful at a metro or regional scale (i.e., activity of regional airports).</p>
<p><strong>2. What type of data do you need to calculate the variable?</strong></p>
<p>What measures are included in your formula? For example, if a new Starbucks impacts home values, you would measure the distance to it for each home. You would need a database of Starbucks in your city with their locations.</p>
<p><strong>3. What is the process or formula you would follow to create the variable?</strong></p>
<p>Write out instructions for calculating your metric in a way that a data engineer could implement. For example, to calculate the distance to the nearest Starbucks:</p>
<ol type="1">
<li><p>Identify the location of each home in the dataset.</p></li>
<li><p>Identify the nearest Starbucks.</p></li>
<li><p>Calculate the distance between the two points.</p></li>
</ol>
<p>Note! These instructions are not specific enough because you can easily calculate the Euclidian distance between two points on a map with a formula, but how often do you travel in a straight line to a destination? Maybe a travel distance time derived from Google maps might be a better metric? Or maybe travel time, rather than distance? Are you assuming people are walking, driving, or taking public transit?</p>
<p><strong>4. How reliable will your measure be?</strong></p>
<p>Using your knowledge about instrument development, do you feel like your new variable will accurately reflect the true underlying latent construct you are trying to measure? For example, using the programs described in the lab, I could fairly accurately measure the total tree canopy cover for a specific neighborhood (the average is about 20% coverage in most cities). If I were trying to create a hipster scale to measure how cool a neighborhood is by identifying how many local menus include craft beer, my scale might be less reliable (largely because craft beer is mainstream, not cool enough).</p>
<p><strong>Looking Ahead</strong></p>
<p>The goal behind the design of the last three labs was (1) to encourage you to think about how the data that we use every day and that has a big impact on our lives is created, and (2) to demystify machine learning and artificial intelligence. These exercises were designed to give you insight into the black box of predictive analytics, remote sensors, and artificial intelligence.</p>
<p>You do not need to know how to build a car from scratch to be a good driver. Similarly, you do not need to be a data scientist to incorporate these new tools into your future career. Your job as a future analyst or manager, for example, may be to determine whether automation or a predictive model would add value to your organization. If so, you can hire an expert to build the models for you.</p>
<p>That said, a little bit of vocabulary will help you write a call for proposals, interview potential firms, and manage the process along the way. The processes of feature selection and measurement can be challenging for an outside expert that doesn’t intimately understand your program. You can add a lot of value by collaborating with the experts during the process to identify latent constructs, select features that are important to the question at hand, and discussing how the data may need to be engineered for analysis and/or modeling.</p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>